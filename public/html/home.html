<!doctype html>
<html>
  <head>
    <title>Home</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="css/home.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand cursive-text" href="/">Latify</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navbarSupportedContent">
          <ul class="navbar-nav navbar-right mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="link-dark text-decoration-none dropdown-toggle hover-pointer" data-bs-toggle="dropdown" aria-expanded="false">
                <img id="userProfileImg" class="img-circle" width="50" height="50">
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/login">New access token</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://accounts.spotify.com/en/logout">Sign out <i class="bi bi-box-arrow-right"></i></a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    
    <br>
    <div id="divAvailableDevices">
      <button id="btnAvailableDevices" class="btn btn-primary">Show available devices</button>
    </div>

    <br>
    <div id="searchArtist" class="container">
      <div class="row">
        <div class="col-md-6 offset-md-3 text-center">
          <div id="divArtistSearchBar" class="d-flex justify-content-between">
            <input type="text" id="txtSearchArtist" class="form-control" placeholder="Enter an artists name">
            <button id="btnSearchArtist" class="btn" type="button"><i class="bi bi-search"></i></button>
          </div>
          <div id="searchArtistErrorMsg"></div>
        </div>
      </div>
    </div>


    <div id="searchArtistResults" class="container">
      <div class="row">
        <div id="artistResults" class="col-md-8 offset-md-2">
          <div id="artistCardGroup" class="row row-cols-1 row-cols-md-4 g-4" style="margin-top: 15px;"></div>
        </div>
      </div>
    </div>

    <div id="divOffCanvas" class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasScrollingLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div id="offcanvas-body"></div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
      const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
      });
      
      const access_token = params.access_token;
      
      $.ajax({
        url: 'https://api.spotify.com/v1/me',
        headers: {
          'Authorization': 'Bearer ' + access_token
        }
      }).done((response) => {
        let navBarProfileImg = document.getElementById('userProfileImg');
        navBarProfileImg.src =  response.images[0].url;
      }); 

      function getSelectedDevice() {
        let deviceOptions = document.getElementsByName('deviceOptions');
        let selectedDeviceId;
        for (const device of deviceOptions) {
          if (device.checked) {
            selectedDeviceId = device.value;
            break;
          }
        };
        return selectedDeviceId;
      }
      
      function showAlbumTracks(albumId) {
        let artistAlbumTracks = document.getElementById(albumId).querySelector('#albumTracks');
        if (artistAlbumTracks)
          artistAlbumTracks.classList.toggle('d-none');
        else {
          $.ajax({
            url: `/artists/album/${albumId}/tracks`,
            type: 'GET',
            data: {'access_token': access_token},
            dataType: 'json',
            contentType: 'application/json charset=utf-8',
            cache: false
          }).done(function (response) {
            let albumRow = document.getElementById(response.albumId);
            let albumTracksTable = document.createElement('table');
            albumTracksTable.id = 'albumTracks';
            albumRow.appendChild(albumTracksTable);
            response.tracks.forEach(track => {
              let trackRow = document.createElement('tr');
              trackRow.className = 'trackRow';
              let trackCell = document.createElement('td');
              trackCell.innerHTML = track.name;
              trackCell.id = track.id;
              
              let playButton = document.createElement('button');
              playButton.classList.add('btn');
              let playIcon = document.createElement('i');
              playIcon.className = 'bi bi-play-circle';
              playButton.appendChild(playIcon);
              playButton.onclick = () => {
                let selectedDeviceId = getSelectedDevice();
                $.ajax({
                  url: `/track/${track.id}/play`,
                  type: 'PUT',
                  data: {'access_token': access_token, 'selectedDeviceId': selectedDeviceId},
                  dataType: 'json',
                  cache: false
                }).done(() => {
                  return;
                });
              };

              let pauseButton = document.createElement('button');
              pauseButton.classList.add('btn');
              let pauseIcon = document.createElement('i');
              pauseIcon.className = 'bi bi-pause-circle';
              pauseButton.appendChild(pauseIcon);
              pauseButton.onclick = () => {
                let selectedDeviceId = getSelectedDevice();
                $.ajax({
                  url: `/track/${track.id}/pause`,
                  type: 'PUT',
                  data: {'access_token': access_token, 'selectedDeviceId': selectedDeviceId},
                  dataType: 'json',
                  cache: false
                }).done(() => {
                  return;
                });
              };

              trackRow.appendChild(trackCell);
              trackRow.appendChild(playButton);
              trackRow.appendChild(pauseButton);
              albumTracksTable.append(trackRow);
            });           
          });
        }
      }

      function showArtistAlbums(artistId, artistName) {
        let artistAlbum = document.getElementById(artistId).querySelector('#artistAlbumTable');
        let offCanvasBody = document.getElementById('offcanvas-body');
            while (offCanvasBody.firstChild) {
              offCanvasBody.removeChild(offCanvasBody.firstChild);
            }
        if (artistAlbum) {
          artistAlbum.classList.toggle('d-none');
        }
        else {
          $.ajax({
            url: `/artists/${artistId}/albums`,
            type: 'GET',
            data: {'access_token': access_token},
            dataType: 'json',
            contentType: 'application/json charset=utf-8',
            cache: false
          }).done((response) => {
            if (response.albums.length === 0)
              offCanvasBody.innerHTML = " artist has no albums to show";
            else{
              let artistAlbumTable = document.createElement('table');
              artistAlbumTable.id = 'artistAlbumTable';
              artistAlbumTable.classList.add('table');
              offCanvasBody.appendChild(artistAlbumTable);
              response.albums.forEach(album => {
                let artistAlbumRow = document.createElement('tr');
                artistAlbumRow.className = 'artistAlbumRow';
                let artistAlbumCell = document.createElement('td');
                artistAlbumCell.id = album.id;
                let artistAlbumImg = document.createElement('img');
                artistAlbumImg.src = album.images[0].url;
                artistAlbumImg.width = '150';
                artistAlbumImg.height = '150';
                artistAlbumImg.setAttribute('onclick', `showAlbumTracks('${album.id}')`)
                artistAlbumCell.appendChild(artistAlbumImg);
                artistAlbumRow.appendChild(artistAlbumCell);
                artistAlbumTable.appendChild(artistAlbumRow);
              });
            }
          });
        }
        document.getElementById('offcanvasScrollingLabel').innerHTML = artistName;
        let offcanvas = new bootstrap.Offcanvas(document.getElementById('divOffCanvas'));
        offcanvas.toggle();
      }

      document.getElementById('btnSearchArtist').addEventListener('click', () => {
        let artist = $('#txtSearchArtist').val(); 
        let searchArtistErrorMsg = document.getElementById('searchArtistErrorMsg');
        let txtSearchArtist = document.getElementById('txtSearchArtist');
        if (artist === '') {
          searchArtistErrorMsg.textContent = 'Input can not be empty';
          searchArtistErrorMsg.classList.add('is-invalidMsg');
          txtSearchArtist.classList.add('is-invalidInput');
        }
        else {
          searchArtistErrorMsg.textContent = '';
          searchArtistErrorMsg.classList.remove('is-invalidMsg');
          txtSearchArtist.classList.remove('is-invalidInput');
          $.ajax({
            url: '/getArtist/' + encodeURIComponent(artist),
            type: 'GET',
            data: {'access_token': access_token},
            dataType: 'json',
            contentType: 'application/json charset=utf-8',
            cache: false
          }).done((response) => {
            response.forEach(artist => {
              let artistCol = document.createElement('div');
              artistCol.classList.add('col');
              artistCardGroup.appendChild(artistCol);
              let artistCard = document.createElement('div');
              artistCard.id = artist.id
              artistCard.classList.add('card', 'card-color', 'h-100', 'hover-pointer');
              artistCard.setAttribute('onclick', `showArtistAlbums('${artist.id}', '${artist.name}')`)
              artistCol.appendChild(artistCard);
              let artistImgDiv = document.createElement('div');
              artistImgDiv.classList.add('card-img-holder');
              artistCard.appendChild(artistImgDiv); 
              let artistCardImg = document.createElement('img');
              artistCardImg.classList.add('card-img-top', 'img-circle');
              artistCardImg.src = artist.images[0].url;
              artistImgDiv.appendChild(artistCardImg);
              let artistCardBody = document.createElement('div');
              artistCardBody.classList.add('card-body');
              artistCard.appendChild(artistCardBody);
              let artistCardBodyTitle = document.createElement('h5');
              artistCardBodyTitle.classList.add('card-title');
              artistCardBodyTitle.textContent = artist.name;
              artistCardBody.appendChild(artistCardBodyTitle);
            });
          }); 
        }
      });

      document.getElementById('btnAvailableDevices').addEventListener('click', () => {
        $.ajax({
          url: '/availableDevices',
          type: 'GET',
          data: {'access_token': access_token},
          dataType: 'json',
          contentType: 'application/json charset=utf-8',
          cache: false
        }).done((response) => {
          let divAvailableDevices = document.getElementById('divAvailableDevices');
          while (divAvailableDevices.children.length > 1) {
              divAvailableDevices.removeChild(divAvailableDevices.lastChild);
          }
          response.forEach(device => {
            let deviceLabel = document.createElement('label');
            deviceLabel.textContent = device.name;
            let deviceInput = document.createElement('input');
            deviceInput.classList.add('deviceOptions');
            deviceInput.type = 'radio';
            deviceInput.name = 'deviceOptions';
            deviceInput.value = device.id;
            
            deviceLabel.appendChild(deviceInput);
            divAvailableDevices.appendChild(deviceLabel);
          });
        });          
      });
    </script>
  </body>
</html>
